<%
  use Gitprep::API;
  
  # API
  my $api = Gitprep::API->new($self);

  # Parameters
  my $user = param('user');
  my $project = param('project');
  my $root_ns = $api->root_ns(config->{root});
  my $rep_ns = "$root_ns/$user/$project.git";
  my $rep = "/$rep_ns";
  
  # Git
  my $git = $self->app->git;
  
  # Default branch
  my $default_branch = {};
  $default_branch->{name} = 'master';
  $default_branch->{commit} = $git->parse_commit($rep, $default_branch->{name});
  
  # No merged branches
  my $branches  = $git->no_merged_branches($rep);
%>

% layout 'common';
  %= include '/css/common';
  
  %= stylesheet begin
    /* h2 */
    h2 {
      font-size:140%;
      padding-bottom:5px;
    }
    
    /* Branches number */
    .branches_number {
      color:#666;
      padding-bottom:5px;
    }
    
    /* Branches */
    .branches {
      width:100%;
    }
    .branches .bdefault {
      width:100%;
      background-color:black;
      color:white;
    }
    .branches .bdefault td {
      padding-left:5px;
      padding-right:5px;
    }
    .branches td {
      padding-top:5px;
      padding-bottom:5px;
      border-bottom:1px solid #E5E5E5;
      vertical-align:middle;
    }
    .branches .bname {
      font-size:120%;
      font-weight:bold;
    }
    
    .branches .blast_updated {
      color:#666;
    }
    .branches .bleft {
      
    }
    .branches .bright {
      text-align:right;
    }
    .branches .bright a {
      color:#333;
      display:inline-block;
      padding:5px;
      border:1px solid #E5E5E5;
      border-radius:3px;
      background-color:#F3F3F3;
    }
    .branches .bright a:hover {
      color:#FFF;
      background-color:#4183C4;
    }
  % end
  
  %= include '/include/header';

  <div class="main_panel">
    %= include '/include/sub_header';
    
    %= include '/include/code_menu';
    %= stylesheet begin
      /* Code menu */
      .code_menu_branches {
        border:1px solid #E5E5E5;
        border-bottom:none;
        background-color:white;
        font-weight:bold;
      }
      .code_menu_branches a {
        color:#333
      }
      
    % end
    
    <h2>Branches</h2>
    
    <div class="branches_number">Showing <%= @$branches %> branches not merged into master</div>
    <table class="branches">
      <tr class="bdefault">
        <td class="bleft">
          <div class="bname"><%= $default_branch->{name} %></div>
          <div class="blast_updated">Last updated <%= $default_branch->{commit}{age_string} %> by <%= $default_branch->{commit}{author_name} %></div>
        </td>
        <td>
          
        </td>
        <td class="bright">
          Base branch
        </td>
      </tr>
    </table>
    <table class="branches">
      % for (my $i = 0; $i < @$branches; $i++) {
        % my $branch = $branches->[$i];
        % my $name = $branch->{name};
        <tr>
          <td class="bleft">
            <div class="bname">
              <a href="<%= url_for("/$user/$project/tree/$name") %>">
                <%= $name %>
              </a>
            </div>
            <div class="blast_updated">Last updated <%= $branch->{commit}{age_string} %> by <%= $branch->{commit}{author_name} %></div>
          </td>
          <td>
            
          </td>
          <td class="bright">
            <a href="<%= url_for("/$user/$project/compare/$default_branch->{name}...$name") %>">Compare</a>
          </td>
        </tr>
      % }
    </table>
  </div>
  
  %= include '/include/footer';
